%%--------------------------------------------------------------------
%% Copyright (c) 2024-2025 EMQ Technologies Co., Ltd. All Rights Reserved.
%%--------------------------------------------------------------------

-module(emqx_ds_stream_share_proto).

-include("emqx_ds_stream_share_proto.hrl").

-include_lib("snabbkaffe/include/snabbkaffe.hrl").

% -type borrower_id() :: ?borrower_id(
%     emqx_ds_shared_sub_agent:subscription_id(),
%     emqx_persistent_session_ds:id(),
%     reference()
% ).

-type borrower() :: {_ID, reference()}.
-type leader() :: pid().

-type leader_stream_progress() :: #{
    stream := stream(),
    progress := emqx_persistent_session_ds_shared_subs:progress()
}.
-type agent_stream_progress() :: emqx_persistent_session_ds_shared_subs:agent_stream_progress().
-type agent_stream_progresses() :: list(agent_stream_progress()).
-type stream() :: emqx_ds:stream().

-type to_leader_msg() ::
    ?borrower_ping_match(borrower())
    | ?borrower_connect_match(borrower(), emqx_ds_stream_share:share())
    | ?borrower_disconnect_match(borrower(), agent_stream_progresses())
    | ?borrower_update_progress_match(borrower(), agent_stream_progress())
    | ?borrower_revoke_finished_match(borrower(), emqx_ds:stream()).

-type to_borrower_msg() ::
    ?leader_connect_response_match(leader())
    | ?leader_ping_response_match(leader())
    | ?leader_grant_match(leader(), leader_stream_progress())
    | ?leader_revoke_match(leader(), emqx_ds:stream())
    | ?leader_revoked_match(leader(), emqx_ds:stream())
    | ?leader_invalidate_match(leader()).

-export_type([
    borrower/0,
    leader/0,
    stream/0,
    leader_stream_progress/0,
    agent_stream_progress/0,
    agent_stream_progresses/0,
    to_leader_msg/0,
    to_borrower_msg/0
]).

-export([
    send_to_leader/2,
    send_to_borrower/2
]).

-export([
    borrower_connect_v3/3,
    borrower_ping_v3/2,
    borrower_disconnect_v3/3,
    borrower_update_progress_v3/3,
    borrower_revoke_finished_v3/3,

    leader_connect_response_v3/2,
    leader_ping_response_v3/2,
    leader_grant_v3/3,
    leader_revoke_v3/3,
    leader_revoked_v3/3,
    leader_invalidate_v3/2
]).

-export([
    borrower_id/3,
    borrower_pidref/1,
    borrower_subscription_id/1
]).

%% Legacy types
-type agent() :: term().
-type group() :: emqx_types:group().
-type version() :: non_neg_integer().
-type agent_metadata() :: #{
    id := emqx_persistent_session_ds:id()
}.

-export_type([
    agent/0,
    group/0,
    version/0,
    agent_metadata/0
]).

%%--------------------------------------------------------------------
%% API
%%--------------------------------------------------------------------

-spec send_to_leader(leader(), to_leader_msg()) -> ok.
send_to_leader(ToLeader, Msg) when node(ToLeader) =:= node() ->
    ?tp(debug, "ds_stream_share_proto_borrower_send", #{
        to_leader => ToLeader,
        proto_msg => Msg
    }),
    _ = erlang:send(ToLeader, Msg),
    ok;
send_to_leader(ToLeader, ?borrower_connect_match(FromBorrowerId, ShareTopicFilter)) ->
    emqx_ds_shared_sub_proto_v3:borrower_connect(
        ?borrower_node(FromBorrowerId), ToLeader, FromBorrowerId, ShareTopicFilter
    );
send_to_leader(ToLeader, ?borrower_ping_match(FromBorrowerId)) ->
    emqx_ds_shared_sub_proto_v3:borrower_ping(
        ?borrower_node(FromBorrowerId), ToLeader, FromBorrowerId
    );
send_to_leader(ToLeader, ?borrower_disconnect_match(FromBorrowerId, StreamProgresses)) ->
    emqx_ds_shared_sub_proto_v3:borrower_disconnect(
        ?borrower_node(FromBorrowerId), ToLeader, FromBorrowerId, StreamProgresses
    );
send_to_leader(ToLeader, ?borrower_update_progress_match(FromBorrowerId, StreamProgress)) ->
    emqx_ds_shared_sub_proto_v3:borrower_update_progress(
        ?borrower_node(FromBorrowerId), ToLeader, FromBorrowerId, StreamProgress
    );
send_to_leader(ToLeader, ?borrower_revoke_finished_match(FromBorrowerId, Stream)) ->
    emqx_ds_shared_sub_proto_v3:borrower_revoke_finished(
        ?borrower_node(FromBorrowerId), ToLeader, FromBorrowerId, Stream
    ).

-spec send_to_borrower(borrower_id(), to_borrower_msg()) -> ok.
send_to_borrower(ToBorrowerId, Msg) when when node(ToLeader) =:= node() ->
    % ?tp(debug, "ds_stream_share_proto_borrower_send", #{
    %     to_leader => ToLeader,
    %     proto_msg => Msg
    % }),
    _ = emqx_ds_shared_sub_agent:send_to_borrower(ToBorrowerId, Msg),
    ok;
send_to_borrower(ToBorrowerId, ?leader_connect_response_match(FromLeader)) ->
    emqx_ds_shared_sub_proto_v3:leader_connect_response(
        ?borrower_node(ToBorrowerId), ToBorrowerId, FromLeader
    );
send_to_borrower(ToBorrowerId, ?leader_ping_response_match(FromLeader)) ->
    emqx_ds_shared_sub_proto_v3:leader_ping_response(
        ?borrower_node(ToBorrowerId), ToBorrowerId, FromLeader
    );
send_to_borrower(ToBorrowerId, ?leader_grant_match(FromLeader, StreamProgress)) ->
    emqx_ds_shared_sub_proto_v3:leader_grant(
        ?borrower_node(ToBorrowerId), ToBorrowerId, FromLeader, StreamProgress
    );
send_to_borrower(ToBorrowerId, ?leader_revoke_match(FromLeader, Stream)) ->
    emqx_ds_shared_sub_proto_v3:leader_revoke(
        ?borrower_node(ToBorrowerId), ToBorrowerId, FromLeader, Stream
    );
send_to_borrower(ToBorrowerId, ?leader_revoked_match(FromLeader, Stream)) ->
    emqx_ds_shared_sub_proto_v3:leader_revoked(
        ?borrower_node(ToBorrowerId), ToBorrowerId, FromLeader, Stream
    );
send_to_borrower(ToBorrowerId, ?leader_invalidate_match(FromLeader)) ->
    emqx_ds_shared_sub_proto_v3:leader_invalidate(
        ?borrower_node(ToBorrowerId), ToBorrowerId, FromLeader
    ).

%%--------------------------------------------------------------------
%% RPC Targets
%%--------------------------------------------------------------------

%% borrower -> leader messages

-spec borrower_connect_v3(leader(), borrower(), emqx_ds_stream_share:share()) -> ok.
borrower_connect_v3(ToLeader, FromBorrowerId, ShareTopicFilter) ->
    send_to_leader(ToLeader, ?borrower_connect(FromBorrowerId, ShareTopicFilter)).

-spec borrower_ping_v3(leader(), borrower()) -> ok.
borrower_ping_v3(ToLeader, FromBorrowerId) ->
    send_to_leader(ToLeader, ?borrower_ping(FromBorrowerId)).

-spec borrower_disconnect_v3(leader(), borrower(), agent_stream_progresses()) -> ok.
borrower_disconnect_v3(ToLeader, FromBorrowerId, StreamProgresses) ->
    send_to_leader(ToLeader, ?borrower_disconnect(FromBorrowerId, StreamProgresses)).

-spec borrower_update_progress_v3(leader(), borrower(), agent_stream_progress()) -> ok.
borrower_update_progress_v3(ToLeader, FromBorrowerId, StreamProgress) ->
    send_to_leader(ToLeader, ?borrower_update_progress(FromBorrowerId, StreamProgress)).

-spec borrower_revoke_finished_v3(leader(), borrower(), stream()) -> ok.
borrower_revoke_finished_v3(ToLeader, FromBorrowerId, Stream) ->
    send_to_leader(ToLeader, ?borrower_revoke_finished(FromBorrowerId, Stream)).

%% leader -> borrower messages

-spec leader_connect_response_v3(borrower(), leader()) -> ok.
leader_connect_response_v3(ToBorrowerId, FromLeader) ->
    send_to_borrower(ToBorrowerId, ?leader_connect_response(FromLeader)).

-spec leader_ping_response_v3(borrower(), leader()) -> ok.
leader_ping_response_v3(ToBorrowerId, FromLeader) ->
    send_to_borrower(ToBorrowerId, ?leader_ping_response(FromLeader)).

-spec leader_grant_v3(borrower(), leader(), leader_stream_progress()) -> ok.
leader_grant_v3(ToBorrowerId, FromLeader, StreamProgress) ->
    send_to_borrower(ToBorrowerId, ?leader_grant(FromLeader, StreamProgress)).

-spec leader_revoke_v3(borrower(), leader(), stream()) -> ok.
leader_revoke_v3(ToBorrowerId, FromLeader, Stream) ->
    send_to_borrower(ToBorrowerId, ?leader_revoke(FromLeader, Stream)).

-spec leader_revoked_v3(borrower(), leader(), stream()) -> ok.
leader_revoked_v3(ToBorrowerId, FromLeader, Stream) ->
    send_to_borrower(ToBorrowerId, ?leader_revoked(FromLeader, Stream)).

-spec leader_invalidate_v3(borrower(), leader()) -> ok.
leader_invalidate_v3(ToBorrowerId, FromLeader) ->
    send_to_borrower(ToBorrowerId, ?leader_invalidate(FromLeader)).

%%--------------------------------------------------------------------
%% Internal API
%%--------------------------------------------------------------------

-spec borrower_id(
    emqx_persistent_session_ds:id(),
    emqx_ds_shared_sub_agent:subscription_id(),
    reference()
) ->
    borrower_id().
borrower_id(SessionId, SubscriptionId, PidRef) ->
    ?borrower_id(SessionId, SubscriptionId, PidRef).

-spec borrower_pidref(borrower_id()) -> reference().
borrower_pidref(BorrowerId) ->
    ?borrower_pidref(BorrowerId).

-spec borrower_subscription_id(borrower_id()) -> emqx_ds_shared_sub_agent:subscription_id().
borrower_subscription_id(BorrowerId) ->
    ?borrower_subscription_id(BorrowerId).
